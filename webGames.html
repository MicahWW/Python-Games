<!DOCTYPE html>

<html lang='en' xmlns='http://www.w3.org/1999/xhtml'>
<head>
    <meta charset='utf-8' />
    <title>Python Games</title>

    <style>
		.board_cell {
			display: inline;
			font-size: 20px;
		}

		div.game_line {
			outline: 1.5px;
			outline-color: black;
			outline-style: solid;
			position: absolute;
		}

		div.game_line_horizontal {
			height: 0px;
			width: 86px;
			left: 7px;
		}

		div.game_line_vertical {
			height: 70px;
			width: 0px;
		}
    </style>
</head>
<body>

    <div>
        <h1 id='gameName'></h1>
    </div>

    <div id='board' style='position: relative;'>
        <div class='game_line game_line_vertical' style='left: 33px'></div>
        <div class='game_line game_line_vertical' style='left: 66px'></div>
        <div class='game_line game_line_horizontal' style='top: 23.5px'></div>
        <div class='game_line game_line_horizontal' style='top: 47px'></div>


        <pre class='board_cell' ; id='pos_zero'>0</pre><pre class='board_cell' ; id='pos_one'>1</pre><pre class='board_cell' ; id='pos_two'>2</pre>
        <br />
        <pre class='board_cell' ; id='pos_three'>3</pre><pre class='board_cell' ; id='pos_four'>4</pre><pre class='board_cell' ; id='pos_five'>5</pre>
        <br />
        <pre class='board_cell' ; id='pos_six'>6</pre><pre class='board_cell' ; id='pos_seven'>7</pre><pre class='board_cell' ; id='pos_eight'>8</pre>

    </div>

	<div>
		<pre style="display: inline" id="game_state"></pre>
		<pre style="display: inline">: </pre>
		<pre style="display: inline" id="current_player">who's turn placeholder</pre>
	</div>

	<div>
		<br />
		<button type="button" onclick="resetGame()">Reset Game</button>
	</div>

    <script defer>
		let baseURL = 'http://127.0.0.1:5000';
		let boardURL = baseURL + '/board';
		let gameNameURL = baseURL + '/gameName';
		let checkMoveURL = baseURL + '/checkValidMove';
		let updateBoardURL = baseURL + '/updateBoard';
		let botMoveURL = baseURL + '/botMove';
		let resetGameURL = baseURL + '/resetGame';
		let gameStateURL = baseURL + '/gameState';

		let userID = -0x1;
		let botID = 0x1;
		let gameState = 0;

		// global vars
////////////////////////////////////////////////////////////////////////////////////////////////////
		// functions

		// updates the TicTacToe board and the game state
		async function displayGame() {
			// grab board details & display
			const boardReq = await fetch(boardURL, { Method: 'GET' });
			var data = await boardReq.json();
			updateScreenBoard(data);

			// grab game state & display
			const stateReq = await fetch(gameStateURL, { Method: 'GET' });
			var data = await stateReq.json();
			gameState = data.game_state;
			switch (gameState) {
				case 0x10:
					document.getElementById('game_state').innerHTML = 'Game in Progress';
					break;
				case 0x20:
					document.getElementById('game_state').innerHTML = 'Player X won!!';
					break;
				case 0x30:
					document.getElementById('game_state').innerHTML = 'Player O won!!';
					break;
				case 0x40:
					document.getElementById('game_state').innerHTML = 'Game ended in a draw';
					break;
			}
        }

		// update the screen with the given board
		function updateScreenBoard(board) {
            let ids = [
                ['pos_zero', 'pos_one', 'pos_two'],
                ['pos_three', 'pos_four', 'pos_five'],
                ['pos_six', 'pos_seven', 'pos_eight']];

            for (let i = 0; i < board.length; i++) {
                for (let j = 0; j < board[i].length; j++) {
                    let value = '';
                    if (board[i][j] == -1) {
                        value = ' X ';
                    } else if (board[i][j] == 0) {
                        value = '   ';
                    } else {
                        value = ' O ';
                    }
					document.getElementById(ids[i][j]).innerHTML = value;
                }
            }
		}

		// send details to server and update the screen
		async function updateBoard(row, col, player) {
			const updateReq = await fetch(updateBoardURL, {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json'
				},
				body: JSON.stringify({ 'row': row, 'col': col, 'player': player })
			});
			var data = await updateReq.json();

			if (data.updated == true) {
				await displayGame();
			} else {
				// ERROR
				console.log('Board didn\'t get updated')
			}
		}

		// called when a user clicks a spot on the board
		async function checkAndUpdate(row, col) {
			if (gameState == 0x10) {
				const checkReq = await fetch(checkMoveURL, {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json'
					},
					body: JSON.stringify({ 'row': row, 'col': col })
				});
				var data = await checkReq.json();
				// If a valid move request to update the board
				if (data.valid == true) {
					await updateBoard(row, col, userID);
					// checks if the game finished after the user moved
					if (gameState == 0x10) {
						processBotMove();
					}
				} else {
					console.log('Data was not valid');
				}
			}
		}

		// get move location generated by server and update the board
		async function processBotMove() {
			const botReq = await fetch(botMoveURL, {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json'
				},
				body: JSON.stringify({ 'player': botID })
			});
			var data = await botReq.json();

			if (data.valid == true) {
				updateBoard(data.row, data.col, botID);
			} else {
				console.log('Data was not valid');
			}
		}

		// requests the server to reset the game
		async function resetGame() {
			fetch(resetGameURL, { method: 'POST' })
				.then((response) => response.json())
				.then((data) => {
					updateScreenBoard(data)
				})
			await displayGame();
		}

		// functions
////////////////////////////////////////////////////////////////////////////////////////////////////


		document.getElementById('pos_zero').onclick = function () {
			checkAndUpdate(0, 0);
		}

		document.getElementById('pos_one').onclick = function () {
			checkAndUpdate(0, 1);
		}

		document.getElementById('pos_two').onclick = function () {
			checkAndUpdate(0, 2);
		}

		document.getElementById('pos_three').onclick = function () {
			checkAndUpdate(1, 0);
		}

		document.getElementById('pos_four').onclick = function () {
			checkAndUpdate(1, 1);
		}

		document.getElementById('pos_five').onclick = function () {
			checkAndUpdate(1, 2);
		}

		document.getElementById('pos_six').onclick = function () {
			checkAndUpdate(2, 0);
		}

		document.getElementById('pos_seven').onclick = function () {
			checkAndUpdate(2, 1);
		}

		document.getElementById('pos_eight').onclick = function () {
			checkAndUpdate(2, 2);
		}

////////////////////////////////////////////////////////////////////////////////////////////////////
		// start game

		fetch(gameNameURL, { Method: 'GET' })
            .then((response) => response.json())
            .then((data) => document.getElementById('gameName').innerHTML = data)

        displayGame()
    </script>
</body>
</html>
